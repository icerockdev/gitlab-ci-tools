variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CHANGELOG_FILE: "changelog.txt"
  XCARCHIVE_NAME: "App.xcarchive"
  XCZIP_NAME: "App.zip"
  IPA_NAME: "App.ipa"
  LANG: "en_US.UTF-8"
  LANGUAGE: "en_US.UTF-8"
  LC_ALL: "en_US.UTF-8"

## Following environments should be provided before job 'script' section called
## 1. match group (team):
# MATCH_PASSWORD      //gitlab env
# FASTLANE_USER       //gitlab env
# FASTLANE_TEAM_ID
# FASTLANE_PASSWORD   //gitlab env
# MATCH_GIT_BRANCH
# MATCH_GIT_URL
# FASTLANE_DONT_STORE_PASSWORD
## 2. project group:
# FIREBASE_TOKEN
# BUILD_APP_IDENTIFIER
# BUILD_SCHEME
# FIREBASE_APP_ID
## 4. additional commands should be called in 'before_script' section
.build_ios_mpp: &build_ios_mpp
  stage: build
  script:
    - export BUILD_NUMBER=$(echo $CI_COMMIT_TAG | rev | cut -d '/' -f1 | rev)
    - fastlane run changelog_from_git_commits tag_match_pattern:build/* | grep -E '^([a-zA-Z]*-.*)' | sed 's/^\([a-zA-Z]*-[0-9]*\).*$/\1/' | sort | uniq |  tr '\n' ',' | sed 's/\(.*\),/\1/' > ${CHANGELOG_FILE} || true
    - cd ./ios-app
    - pod install --repo-update
    - cd ..
    - ./gradlew syncMultiPlatformLibraryReleaseFrameworkIosArm64
    - cd ./ios-app
    - mkdir fastlane || true
    - curl https://gitlab.icerockdev.com/scl/fastlane-ios/-/raw/master/Fastfile --output fastlane/Fastfile
    - fastlane build
  artifacts:
    paths:
      - ./ios-app/${XCZIP_NAME}
      - ${CHANGELOG_FILE}
    expire_in: 2 days
  except:
    - branches
  tags:
    - gradle
    - fastlane
    - osx
    - xcode


## Following environments should be provided before job 'script' section called
## 1. match group (team):
# MATCH_PASSWORD      //gitlab env
# FASTLANE_USER       //gitlab env
# FASTLANE_TEAM_ID
# FASTLANE_PASSWORD   //gitlab env
# MATCH_GIT_BRANCH
# MATCH_GIT_URL
# FASTLANE_DONT_STORE_PASSWORD
## 2. project group:
# FIREBASE_TOKEN
# BUILD_APP_IDENTIFIER
# BUILD_SCHEME
# FIREBASE_APP_ID
## 4. additional commands should be called in 'before_script' section
.build_ios_native: &build_ios_native
  stage: build
  script:
    - export BUILD_NUMBER=$(echo $CI_COMMIT_TAG | rev | cut -d '/' -f1 | rev)
    - fastlane run changelog_from_git_commits tag_match_pattern:build/* | grep -E '^([a-zA-Z]*-.*)' | sed 's/^\([a-zA-Z]*-[0-9]*\).*$/\1/' | sort | uniq |  tr '\n' ',' | sed 's/\(.*\),/\1/' > ${CHANGELOG_FILE} || true
    - mkdir fastlane || true
    - curl https://gitlab.icerockdev.com/scl/fastlane-ios/-/raw/master/Fastfile --output fastlane/Fastfile
    - fastlane build
  artifacts:
    paths:
      - ${XCZIP_NAME}
      - ${CHANGELOG_FILE}
    expire_in: 2 days
  except:
    - branches
  tags:
    - fastlane
    - osx
    - xcode

## Following environments should be provided before job 'script' section called
## 1. match group (team):
# MATCH_PASSWORD      //gitlab env
# FASTLANE_USER       //gitlab env
# FASTLANE_TEAM_ID
# FASTLANE_PASSWORD   //gitlab env
# MATCH_GIT_BRANCH
# MATCH_GIT_URL
# FASTLANE_DONT_STORE_PASSWORD
## 2. project group:
# FIREBASE_TOKEN
# BUILD_APP_IDENTIFIER
# BUILD_SCHEME
# FIREBASE_APP_ID
## 3. build settings:
# BUILD_EXPORT_METHOD //(ad-hoc/enterprise)
## 4. additional commands should be called in 'before_script' section
.deploy_ios_mpp_firebase: &deploy_ios_mpp_firebase
  stage: deploy
  script:
    - mv ${CHANGELOG_FILE} ./ios-app/
    - cd ./ios-app
    - mkdir fastlane || true
    - curl https://gitlab.icerockdev.com/scl/fastlane-ios/-/raw/master/Fastfile --output fastlane/Fastfile
    - fastlane deploy_firebase
  artifacts:
    paths:
      - ./ios-app/${IPA_NAME}
      - ${CHANGELOG_FILE}
    expire_in: 2 days
  tags:
    - fastlane
    - xcode
    - osx

## Following environments should be provided before job 'script' section called
## 1. match group (team):
# MATCH_PASSWORD      //gitlab env
# FASTLANE_USER       //gitlab env
# FASTLANE_TEAM_ID
# FASTLANE_PASSWORD   //gitlab env
# MATCH_GIT_BRANCH
# MATCH_GIT_URL
# FASTLANE_DONT_STORE_PASSWORD
## 2. project group:
# FIREBASE_TOKEN
# BUILD_APP_IDENTIFIER
# BUILD_SCHEME
# FIREBASE_APP_ID
## 3. build settings:
# BUILD_EXPORT_METHOD //(ad-hoc/enterprise)
## 4. additional commands should be called in 'before_script' section
.deploy_ios_firebase: &deploy_ios_firebase
  stage: deploy
  script:
    - mkdir fastlane || true
    - curl https://gitlab.icerockdev.com/scl/fastlane-ios/-/raw/master/Fastfile --output fastlane/Fastfile
    - fastlane deploy_firebase
  artifacts:
    paths:
      - ${IPA_NAME}
      - ${CHANGELOG_FILE}
    expire_in: 2 days
  tags:
    - fastlane
    - xcode
    - osx

## Following environments should be provided before job 'script' section called
## 1. match group (team):
# MATCH_PASSWORD      //gitlab env
# FASTLANE_USER       //gitlab env
# FASTLANE_TEAM_ID
# FASTLANE_PASSWORD   //gitlab env
# MATCH_GIT_BRANCH
# MATCH_GIT_URL
# FASTLANE_DONT_STORE_PASSWORD
## 2. project group:
# FIREBASE_TOKEN
# BUILD_APP_IDENTIFIER
# BUILD_SCHEME
# FIREBASE_APP_ID
# FASTLANE_ITC_TEAM_ID
## 3. additional commands should be called in 'before_script' section
.deploy_ios_appstore: &deploy_ios_appstore
  stage: deploy
  script:
    - mkdir fastlane || true
    - curl https://gitlab.icerockdev.com/scl/fastlane-ios/-/raw/master/Fastfile --output fastlane/Fastfile
    - fastlane deploy_appstore
  artifacts:
    paths:
      - ${IPA_NAME}
      - ${CHANGELOG_FILE}
    expire_in: 2 days
  tags:
    - fastlane
    - xcode
    - osx

## Following environments should be provided before job 'script' section called
## 1. match group (team):
# MATCH_PASSWORD      //gitlab env
# FASTLANE_USER       //gitlab env
# FASTLANE_TEAM_ID
# FASTLANE_PASSWORD   //gitlab env
# MATCH_GIT_BRANCH
# MATCH_GIT_URL
# FASTLANE_DONT_STORE_PASSWORD
## 2. project group:
# FIREBASE_TOKEN
# BUILD_APP_IDENTIFIER
# BUILD_SCHEME
# FIREBASE_APP_ID
# FASTLANE_ITC_TEAM_ID
## 3. additional commands should be called in 'before_script' section
.deploy_ios_mpp_appstore: &deploy_ios_mpp_appstore
  stage: deploy
  script:
    - mv ${CHANGELOG_FILE} ./ios-app/
    - cd ./ios-app
    - mkdir fastlane || true
    - curl https://gitlab.icerockdev.com/scl/fastlane-ios/-/raw/master/Fastfile --output fastlane/Fastfile
    - fastlane deploy_appstore
  artifacts:
    paths:
      - ./ios-app/${IPA_NAME}
      - ${CHANGELOG_FILE}
    expire_in: 2 days
  tags:
    - fastlane
    - xcode
    - osx

dump_job_for_ci_syntax_checking:
  extends:
    - .build_ios_native
    - .build_ios_mpp
    - .deploy_ios_mpp_appstore
    - .deploy_ios_appstore
    - .deploy_ios_mpp_firebase
    - .deploy_ios_firebase
